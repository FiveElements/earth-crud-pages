<link rel="import" href="../polymer/polymer-element.html">

<link rel="import" href="../iron-pages/iron-pages.html">


<link rel="import" href="../app-route/app-route.html">

<dom-module id="earth-crud-pages">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>

        <app-route route="{{route}}" pattern="/:page"
                   data="{{routeData}}"
                   tail="{{subroute}}">
        </app-route>

        <app-route route="{{route}}" pattern="/:page/:id"
                   data="{{routeEditData}}"
                   tail="{{subrouteEdit}}}">
        </app-route>

        <iron-pages id="pages" selected="[[page]]" attr-for-selected="[[attrForSelected]]"
                    fallback-selection="fallback"
                    role="main">
            <slot></slot>
            <div page="fallback">
                <slot name="fallback">
                    <h1>404 Page Not Found !!!</h1>
                </slot>
            </div>
        </iron-pages>


    </template>

    <script>
        /**
         * `earth-crud-pages`
         * Polymer 2 Crud pages
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class EarthCrudPages extends Polymer.Element {
            static get is() {
                return 'earth-crud-pages';
            }

            static get properties() {
                return {
                    attrForSelected: {
                        type: String,
                        value: 'page'
                    },
                    route: {
                        type: Object,
                        notify: true
                    },

                    routeData: {
                        type: Object,
                        observer: '_routeDataChanged',
                        notify: true
                    },
                    routeEditData: {
                        type: Object,
                        observer: '_routeDataChanged',
                        notify: true
                    },
                    subroute: {
                        type: Object,
                        notify: true
                    },
                    subrouteEdit: {
                        type: Object,
                        notify: true
                    },
                    page: {
                        type: String,
                        notify: true
                    },
                    entityId: {
                        type: Object,
                        notify: true
                    },
                };
            }

            // --- Life Cycle
            // --- ---------------------------

            constructor() {
                super();
                this._boundListenerChangePageEvent = this._changePageEvent.bind(this);
            }

            connectedCallback() {
                super.connectedCallback();
                this.addEventListener('earth-page', this._boundListenerChangePageEvent);
            }

            disconnectedCallback() {
                super.disconnectedCallback();
                this.removeEventListener('earth-page', this._boundListenerChangePageEvent);
            }


            // --- Observer
            // --- ---------------------------

            _routeChanged(newValue, oldValue) {
                console.log('------------ _routeChanged ', JSON.stringify(newValue));
            }

            _routeDataChanged(newValue, oldValue) {
                console.log('_routeDataChanged ', JSON.stringify(newValue));
                this._print();
                this.page = newValue.page;
            }

            // --- Route
            // --- ---------------------------

            _changePageEvent(e) {
                const detail = e.detail;
//                console.log('_changePageEvent', detail);
                e.preventDefault();

                this.entityId = detail.id;
                this.page = detail.page;
                this._changeUrl(detail);
            }

            _changeUrl(opt) {
                const newRoute = JSON.parse(JSON.stringify(this.route));
//                const newRoute = Object.assign({}, this.route,opt);
                newRoute.path = '/' + opt.page;
                if (opt.id) {
                    newRoute.path += '/' + opt.id;
                }
//                newRoute.prefix = '/sam';
                this.route = newRoute;
            }


            _print() {
                console.log('route : ', JSON.stringify(this.route));
                console.log('routeData : ', JSON.stringify(this.routeData));
                console.log('routeEditData : ', JSON.stringify(this.routeEditData));
                console.log('subroute : ', JSON.stringify(this.subroute));
                console.log('subrouteEdit : ', JSON.stringify(this.subrouteEdit));
            }

        }

        window.customElements.define(EarthCrudPages.is, EarthCrudPages);
    </script>
</dom-module>
