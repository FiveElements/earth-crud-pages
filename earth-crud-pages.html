<link rel="import" href="../polymer/polymer-element.html">

<link rel="import" href="../iron-pages/iron-pages.html">


<link rel="import" href="../app-route/app-route.html">
<link rel="import" href="../paper-input/paper-input.html">

<dom-module id="earth-crud-pages">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>


        <app-route route="{{route}}" pattern="/:page"
                   data="{{pathData}}"
                   tail="{{subroute}}">
        </app-route>

        <!--<app-route route="{{route}}" pattern="/:page/:id"-->
                   <!--data="{{routeEditData}}"-->
                   <!--tail="{{subrouteEdit}}}">-->
        <!--</app-route>-->
        <app-route route="{{subroute}}" pattern="/:id"
                   data="{{routeData}}"
                   query-params="{{routeParams}}"
                   tail="{{subrouteTail}}">
        </app-route>

        <iron-pages id="pages" selected="[[page]]" attr-for-selected="[[attrForSelected]]"
                    fallback-selection="fallback"
                    role="main">
            <slot></slot>
            <div page="fallback">
                <slot name="fallback">
                    <h1>[[page]] 404 Page Not Found !!!</h1>
                </slot>
            </div>
        </iron-pages>


    </template>

    <script>
        /**
         * `earth-crud-pages`
         * Polymer 2 Crud pages
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class EarthCrudPages extends Polymer.Element {
            static get is() {
                return 'earth-crud-pages';
            }

            static get properties() {
                return {
                    attrForSelected: {
                        type: String,
                        value: 'page'
                    },
                    route: {
                        type: Object,
                        notify: true
                    },

                    pathData: {
                        type: Object,
                        observer: '_pathDataChanged',
                        notify: true
                    },
                    subroute: {
                        type: Object,
                        notify: true
                    },
                    /** Subroute **/
                    routeData: {
                        type: Object,
                        notify: true
                    },
                    subrouteTail: {
                        type: Object,
                        notify: true,
                        value: function () { return {}; }
                    },
                    /** params **/
                    routeParams: {
                        type: Object,
                        notify: true
                    },
                    page: {
                        type: String,
                        notify: true
                    },
                    entityId: {
                        type: Object,
                        notify: true
                    },
                };
            }



            // --- Life Cycle
            // --- ---------------------------

            constructor() {
                super();
                this._boundListenerChangePageEvent = this._changePageEvent.bind(this);
            }

            connectedCallback() {
                super.connectedCallback();
                this.addEventListener('earth-page', this._boundListenerChangePageEvent);
            }

            disconnectedCallback() {
                super.disconnectedCallback();
                this.removeEventListener('earth-page', this._boundListenerChangePageEvent);
            }


            // --- Observer
            // --- ---------------------------
            _pathDataChanged(newValue, oldValue) {
                console.log('_routeDataChanged ', JSON.stringify(newValue));
                this._print(true);
                this.page = newValue.page;
            }

//            _routeDataEditChanged(newValue, oldValue) {
//                console.log('_routeDataChangedEdit ', JSON.stringify(newValue));
//                this._print(false);
//                this.page = newValue.page;
//            }

            // --- Route
            // --- ---------------------------

            _changePageEvent(e) {
                console.log('---- receive event earth-page', e);
                const detail = e.detail;
                console.log('_changePageEvent', detail);
                e.preventDefault();
//                this.entityId = detail.id;
//                this.page = detail.page;
                this._changeUrl(detail);
            }

            _changeUrl(opt) {
                let path = '/' + opt.page;
                if (opt.id) {
                    path += '/' + opt.id;
                }
                this.set('route.path', path);
            }



            _print(type) {
                if (type) {
                    console.log('..............................................................................');
                    console.log('... route : ', JSON.stringify(this.route));
                    console.log('... pathData : ', JSON.stringify(this.pathData));
                    console.log('... routeParams : ', JSON.stringify(this.routeParams));
                    console.log('..............................................................................');
                } else {
                    console.log('..............................................................................');
                    console.log('... ... subroute : ', JSON.stringify(this.subroute));
                    console.log('... ... routeData : ', JSON.stringify(this.routeData));
                    console.log('... ... subrouteTail : ', JSON.stringify(this.subrouteTail));
                    console.log('..............................................................................');
                }

            }

        }

        window.customElements.define(EarthCrudPages.is, EarthCrudPages);
    </script>
</dom-module>
